# Backend API - Weather Insights Service

This backend API serves the **latest processed weather insights** that were generated by the Vertex AI processor function. It acts as the data provider for the React UI hosted on GKE.

The API runs on **Google Cloud Run**, reads the newest JSON file from the `processed_weather_data/` directory in a Google Cloud Storage bucket, and exposes it through a simple REST endpoint.

---

# Table of Contents

- [Purpose](#purpose)
- [API Endpoint](#api-endpoint)
- [How it works](#how-it-works)
- [Environment Variables](#environment-variables)
- [Deployment](#deployment)
- [Manual Verification](#manual-verification)
- [Used by (Frontend Integration)](#used-by-frontend-integration)
- [File Structure](#file-structure)
- [Summary](#summary)

---

# Purpose

This service provides the frontend with **ready-to-display weather insights**, enriched using Vertex AI (Gemini). The processor Cloud Function writes enriched weather data into a GCS folder, and this API fetches the **latest file** and returns its contents.

The API:

- Reads the most recent JSON file from `gs://<bucket>/processed/`
- Returns the JSON response for the UI

# API Endpoint

### **GET /weather**

Returns the latest processed weather insights.

#### Request

No parameters.

#### Response Example

```json
{
  "data": {
    "model": "gemini-2.5-flash",
    "processed_at": "2025-11-17T05:41:03.041383+00:00",
    "result": {
      "Delhi": {
        "mood": "hazy",
        "summary": "Delhi is experiencing hazy conditions with limited visibility, a mild temperature of about 19°C, and a light breeze."
      },
      "London": {
        "mood": "overcast",
        "summary": "A cool and overcast day with temperatures around 5°C, feeling a bit colder, and a gentle breeze."
      },
      "New York": {
        "mood": "chilly",
        "summary": "New York is chilly and fully overcast, with temperatures around 5°C but feeling below freezing, accompanied by strong, gusty winds."
      },
      "Sydney": {
        "mood": "pleasant",
        "summary": "Sydney offers pleasant weather with scattered clouds, light breezes, and comfortable temperatures around 23°C."
      },
      "Tokyo": {
        "mood": "mild",
        "summary": "A mild and breezy day in Tokyo with few clouds and comfortable temperatures around 22°C."
      }
    },
    "source_file": "raw_weather_data/weather-20251117-054021.json"
  },
  "source": "processed_weather_data/processed-20251117-054103.json",
  "status": "success"
}
```

---

# How It Works

1. Picks the most recent processed JSON file from GCS based on filename/timestamp.
2. Reads and loads its content.
3. Returns the JSON as an API response.
4. Runs on Cloud Run (serverless, auto-scaling).

---

# Environment Variables

The service requires:

| Variable          | Description                                                      |
| ----------------- | ---------------------------------------------------------------- |
| `GCS_BUCKET_NAME` | Name of the bucket containing `processed_weather_data/` insights |
| `PROJECT_ID`      | GCP Project ID                                                   |

These are _injected during Cloud Run deployment_.

---

# Deployment

You can deploy the API using gcloud cli:

```bash
gcloud run deploy weather-backend-api \
  --source ./backend/api \
  --region=<region> \
  --allow-unauthenticated \
  --service-account=<process-service-account>
  --set-env-var="PROJECT_ID=<project id>,GCS_BUCKET_NAME=<gcs bucket name>"
```

The service automatically listens on port **8080**.

---

# Manual Verification

1. Call the endpoint:
   ```bash
   curl <cloud-run-url>/weather
   ```
2. Ensure JSON is returned.
3. Check timestamps to confirm the latest file is fetched.
4. Confirm the UI is displaying the same results.

---

# Used By (Frontend Integration)

The React frontend (deployed on GKE) **polls** this endpoint every **10 minutes** to update the weather insights table.

---

# File Structure

```
backend/api/
├── main.py
├── requirements.txt
└── README.md
```

---

# Summary

This backend API is a lightweight, efficient service connecting GCS-stored insights to the frontend UI. It enables a smooth data pipeline from ingestion → processing → visualization.
